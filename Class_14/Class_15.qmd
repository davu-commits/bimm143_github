---
title: "Class_15: Mini Project"
author: "Dan Vu (PID: A17380158)"
format: pdf
toc: TRUE
---

```{r}
library(DESeq2)
```


##Data Import

Reading the `counts` and `metadata` CSV files.

```{r}
counts <- read.csv("GSE37704_featurecounts.csv", row.names = 1)
metadata <- read.csv("GSE37704_metadata.csv")
```


Check on data structure

```{r}
head(counts)
```

> Q. Complete the code below to remove the troublesome first column from countData

Some book-keeping is required as there looks to be a mis-match between counts and metadata.

```{r}
cleancounts <- counts[,-1]
colnames(cleancounts)
```


```{r}
nrow(metadata)
```

> Q. Complete the code below to filter countData to exclude genes (i.e. rows) where we have 0 read count across all samples (i.e. columns).

### Remove the zero count genes

There are lots of rows with zero counts. We can remove these from further analysis.

```{r}
head(cleancounts)
```
```{r}
to.keep.inds <- rowSums(cleancounts) > 0
nonzero_counts <- cleancounts[to.keep.inds,]
head(nonzero_counts)
```


Setup DESeq object

```{r}
dds = DESeqDataSetFromMatrix(
  countData = nonzero_counts,
  colData = metadata,
  design =~condition
)
```

Run DESeq
```{r}
dds <- DESeq(dds)
dds
```


Get results

> Q. Call the summary() function on your results to get a sense of how many genes are up or down-regulated at the default 0.1 p-value cutoff.

```{r}
res = results(dds, contrast=c("condition", "hoxa1_kd", "control_sirna"))
summary(res)
```


```{r}
res <- results(dds)
head(res)
```

## Data Visualization

```{r}
library(dplyr)
```


> Q. Improve this plot by completing the below code, which adds color and axis labels

```{r}
plot( res$log2FoldChange, -log(res$padj) )
```
```{r}
mycols <- rep("gray", nrow(res) )


mycols[ abs(res$log2FoldChange) > 2 & !is.na(res$padj)] <- "red"

inds <- (res$padj < 0.01) & (abs(res$log2FoldChange) > 2) & (!is.na(res$padj))
mycols[ inds ] <- "blue"

plot(
  res$log2FoldChange,
  -log10(res$padj), 
  col = mycols,
  xlab = "Log2(FoldChange)",
  ylab = "-Log10(Adjusted P-value)", 
  pch = 20
)
```


## Add Annotation

Add gene symbols and entrez ids

```{r}
library(AnnotationDbi)
library(org.Hs.eg.db)
columns(org.Hs.eg.db)
```
> Q. Use the mapIDs() function multiple times to add SYMBOL, ENTREZID and GENENAME annotation to our results by completing the code below.

```{r}
res$symbol <- mapIds(x=org.Hs.eg.db,
       keys = row.names(res),
       keytype = "ENSEMBL",
       column = "SYMBOL",
       multiVals="first")

res$entrez <- mapIds(x=org.Hs.eg.db,
       keys = row.names(res),
       keytype = "ENSEMBL",
       column = "ENTREZID",
       multiVals="first")

res$name <- mapIds(x=org.Hs.eg.db,
       keys = row.names(res),
       keytype = "ENSEMBL",
       column = "GENENAME",
       multiVals="first")
```

```{r}
head(res, 10)
```


## Pathway Analysis

```{r}
library(gage)
library(gageData)
library(pathview)
```

We need a named vector of fold-change values as input for gage

```{r}
data(kegg.sets.hs)
data(sigmet.idx.hs)

# Focus on signaling and metabolic pathways only
kegg.sets.hs = kegg.sets.hs[sigmet.idx.hs]
head(kegg.sets.hs, 3)
```


```{r}
foldchanges <- res$log2FoldChange
names(foldchanges) <- res$entrez
head(foldchanges)
```

```{r}
data("kegg.sets.hs")
keggres = gage(foldchanges, gsets=kegg.sets.hs)
```

```{r}
attributes(keggres)
```


```{r}
head(keggres$less)
```

```{r}
pathview(gene.data=foldchanges, pathway.id="hsa04110")
```

![](hsa04110.pathview.png)

Now, let's process our results a bit more to automagicaly pull out the top 5 upregulated pathways, then further process that just to get the pathway IDs needed by the pathview() function. We'll use these KEGG pathway IDs for pathview plotting below.

```{r}
## Focus on top 5 upregulated pathways here for demo purposes only
keggrespathways <- rownames(keggres$greater)[1:5]

# Extract the 8 character long IDs part of each string
keggresids1 = substr(keggrespathways, start=1, stop=8)
keggresids1
```

```{r}
pathview(gene.data=foldchanges, pathway.id=keggresids1, species="hsa")
```

![](hsa04060.pathview.png)
![](hsa05332.pathview.png)
> Q. Can you do the same procedure as above to plot the pathview figures for the top 5 down-reguled pathways?

```{r}
keggrespathways <- rownames(keggres$less)[1:5]
keggresids2 = substr(keggrespathways, start=1, stop=8)
keggresids2
```
```{r}
pathview(gene.data=foldchanges, pathway.id=keggresids2, species="hsa")
```

![](hsa03030.pathview.png)
etc. etc.

### GO terms

Same analysis but using GO genesets instead of KEGG
```{r}
data(go.sets.hs)
data(go.subs.hs)

# Focus on Biological Process subset of GO
gobpsets = go.sets.hs[go.subs.hs$BP]

gobpres = gage(foldchanges, gsets=gobpsets, same.dir=TRUE)

lapply(gobpres, head)
```

### Reactome

Lots of folks like the Reactome interface. You can also run this as an R function but let's look at the website.

The website wants a text file with one gene symbol per line of the genes you want to map to pathways. 

```{r}
#res$symbol
sig_genes <- res[res$padj <= 0.05 & !is.na(res$padj), "symbol"]
print(paste("Total number of significant genes:", length(sig_genes)))
write.table(sig_genes, file="significant_genes.txt", row.names=FALSE, col.names=FALSE, quote=FALSE)
```
> Q: What pathway has the most significant “Entities p-value”? Do the most significant pathways listed match your previous KEGG results? What factors could cause differences between the two methods?

It's stated that the RHO GTPase cycle has the most siginificant "Entities p-value". These most significant pathways do not list the previous KEGG results, but I'm unsure as to what would cause these differences.

## Save our Results
> Q. Finally for this section let's reorder these results by adjusted p-value and save them to a CSV file in your current project directory.

```{r}
res = res[order(res$pvalue),]
write.csv(res, file = "myresults.csv")
```

